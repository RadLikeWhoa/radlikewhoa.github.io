{"componentChunkName":"component---src-templates-article-js","path":"/articles/jsonp","webpackCompilationHash":"dd8f89bc705490318614","result":{"data":{"site":{"siteMetadata":{"siteUrl":"https://sacha.me"}},"markdownRemark":{"html":"<p>JSONP is a way to share data between different domains. As the name suggests, it stems from JSON (\"JavaScript Object Notation\"), but with a wrapper around it (called \"padding\").</p>\n<p>Now, you might be wondering what's wrong with using plain JSON. Most browsers follow the so-called <a href=\"https://developer.mozilla.org/en-US/docs/Web/Security/Same-origin_policy\" title=\"Same-origin policy on MDN\">same-origin policy</a> which prevents websites from accessing files from other domains unless that permission is explicitly granted through <a href=\"http://en.wikipedia.org/wiki/Cross-origin_resource_sharing\" title=\"CORS on Wikipedia\">CORS</a>. The only part of a website that isn't subject to this is the script tag.</p>\n<p>Knowing that we can use this trick to get around the same origin policy we can embed a script file served from a different domain containing something a little like the following.</p>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span> <span class=\"token attr-name\">src</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>http://example.com/people/1234?callback=awesome<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token script\"></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token function\">awesome</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"Id\"</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1234</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Name\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"Foo\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Job\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"Bar\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>What exactly have we done here? We've added a script tag with its source set to a JSON resource on a different domain. But in the src-attribute we specify a callback parameter—<code class=\"language-text\">callback=</code>, sometimes also <code class=\"language-text\">jsonp=</code>—which you'll notice again in the actual response. This is the \"P\" in JSONP, the padding. Ideally, the callback you specify should exist before requesting the external resource.</p>\n<p>To sum it up, a JSONP script calls a function with the data you've requested as the only argument.</p>\n<h3 id=\"but-i-want-an-easy-to-use-function\"><a href=\"#but-i-want-an-easy-to-use-function\" aria-label=\"but i want an easy to use function permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>But I want an easy-to-use function!</h3>\n<p>It can be very much cumbersome to always go through the following steps:</p>\n<ol>\n<li>Define a callback function that will receive the data later on.</li>\n<li>Add the script tag to request the data.</li>\n<li>Clean up?</li>\n</ol>\n<p>That's why libraries like jQuery have <a href=\"http://api.jquery.com/jQuery.getJSON/\" title=\"jQuery&#x27;s getJSON function\">made it easy</a> to request JSONP data. Note the callback parameter. This tells jQuery that it should perform a JSONP request, otherwise you'd get an error because it would try to perform an AJAX request.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">$<span class=\"token punctuation\">.</span><span class=\"token function\">getJSON</span><span class=\"token punctuation\">(</span><span class=\"token string\">'http://example.com/people/1234?callback=?'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">data</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>But in the end it's pretty easy to define such a function to properly understand it. So let's do just that. Don't worry, I'll walk you through it step by step in just a second.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">var</span> _callbacks <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\n\n  window<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">jsonp</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">url<span class=\"token punctuation\">,</span> callback</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">var</span> id <span class=\"token operator\">=</span> <span class=\"token string\">'jsonp_cb_'</span> <span class=\"token operator\">+</span> _callbacks<span class=\"token punctuation\">,</span>\n        existing <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span>scripts<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        script <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token string\">'script'</span><span class=\"token punctuation\">)</span>\n\n    script<span class=\"token punctuation\">.</span>src <span class=\"token operator\">=</span> url <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">~</span>url<span class=\"token punctuation\">.</span><span class=\"token function\">indexOf</span><span class=\"token punctuation\">(</span><span class=\"token string\">'?'</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">?</span> <span class=\"token string\">'&amp;'</span> <span class=\"token punctuation\">:</span> <span class=\"token string\">'?'</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">'callback='</span> <span class=\"token operator\">+</span> id\n    existing<span class=\"token punctuation\">.</span>parentNode<span class=\"token punctuation\">.</span><span class=\"token function\">insertBefore</span><span class=\"token punctuation\">(</span>script<span class=\"token punctuation\">,</span> existing<span class=\"token punctuation\">)</span>\n\n    window<span class=\"token punctuation\">[</span>id<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">data</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      script<span class=\"token punctuation\">.</span>parentNode<span class=\"token punctuation\">.</span><span class=\"token function\">removeChild</span><span class=\"token punctuation\">(</span>script<span class=\"token punctuation\">)</span>\n      <span class=\"token function\">callback</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">delete</span> window<span class=\"token punctuation\">[</span>id<span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">}</span>\n\n    _callbacks <span class=\"token operator\">+=</span> <span class=\"token number\">1</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>This piece of code adds a <code class=\"language-text\">jsonp</code> function to the <code class=\"language-text\">window</code> that accepts the url you want to send a request to and a callback to exectue once this request has finished. The callback you specify is attached to the window so the requested script has no problem finding and calling it. After the callback has finished, both the external resource and the <code class=\"language-text\">window</code>'s newly attached callback function will be removed.</p>\n<p>First off, we wrap everything in an <a href=\"http://benalman.com/news/2010/11/immediately-invoked-function-expression/\" title=\"Ben Alman on IIFE\">immediately-invoked function expression</a> so we can mind our own business without interfering with any other scripts on the page.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Next we'll take care of the ID. We need a unique identifier to name our callback so we don't clash with any other callbacks. We use the <code class=\"language-text\">_callbacks</code> variable to store a simple number which we'll increment with every function call.</p>\n<p>In the actual <code class=\"language-text\">jsonp</code> function we set up our variables first.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">var</span> id <span class=\"token operator\">=</span> <span class=\"token string\">'jsonp_cb_'</span> <span class=\"token operator\">+</span> _callbacks<span class=\"token punctuation\">,</span>\n    existing <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementsByTagName</span><span class=\"token punctuation\">(</span><span class=\"token string\">'script'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    script <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token string\">'script'</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p><code class=\"language-text\">id</code> holds the string \"jsonp<em>cb</em>\" joined with our previously defined number because, as you might know, variables in JavaScript must not start with a number. Also, just the number might not be so unique after all. The next two variables are references to the first script on the page (<code class=\"language-text\">existing</code>) which we'll use insert our new script (<code class=\"language-text\">script</code>).</p>\n<p>After setting all our variables we'll have to build up the scripts source and actually insert it into the page.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">script<span class=\"token punctuation\">.</span>src <span class=\"token operator\">=</span> url <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">~</span>url<span class=\"token punctuation\">.</span><span class=\"token function\">indexOf</span><span class=\"token punctuation\">(</span><span class=\"token string\">'?'</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">?</span> <span class=\"token string\">'&amp;'</span> <span class=\"token punctuation\">:</span> <span class=\"token string\">'?'</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">'callback='</span> <span class=\"token operator\">+</span> id\nexisting<span class=\"token punctuation\">.</span>parentNode<span class=\"token punctuation\">.</span><span class=\"token function\">insertBefore</span><span class=\"token punctuation\">(</span>script<span class=\"token punctuation\">,</span> existing<span class=\"token punctuation\">)</span></code></pre></div>\n<p>When setting the src-attribute we check if it contains a question mark already. If it does we'll have to add the callback parameter preceded by an ampersand, otherwise preceded by a question mark. This is simply how query strings are handled. The callback parameter is set to a function with the unique name we have stored in our ID. You'll see this function in a second.</p>\n<p>Inserting a DOM node isn't the prettiest thing in JavaScript, but it's easy. We'll insert the newly created script right before the first existing script. To do that, we'll have to access the existing script's parent—usually the <code class=\"language-text\">&lt;head&gt;</code> or the <code class=\"language-text\">&lt;body&gt;</code>—and call the <code class=\"language-text\">insertBefore</code> method on it. This method receives the new DOM node to be insterted and the node it should be insterted before.</p>\n<p>At this point we'll have to attach the callback function to the window.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">window<span class=\"token punctuation\">[</span>id<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">data</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  script<span class=\"token punctuation\">.</span>parentNode<span class=\"token punctuation\">.</span><span class=\"token function\">removeChild</span><span class=\"token punctuation\">(</span>script<span class=\"token punctuation\">)</span>\n  <span class=\"token function\">callback</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">delete</span> window<span class=\"token punctuation\">[</span>id<span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>You might be suprised that this is not the function you actually define when calling <code class=\"language-text\">jsonp</code>. This is because this function also handles the cleaning up for you. First it removes the requested script from the page, then it calls your callback from the function call and at the end it will remove itself from the window. That means that there are no unnecessary traces left from your request and you can handle the data however you want.</p>\n<p>(Note: Deleting a property on the window might cause errors in older browsers. There are <a href=\"http://stackoverflow.com/questions/1073414/deleting-a-window-property-in-ie\" title=\"Solution for the delete property bug in older browsers\">easy ways</a> around this though.)</p>\n<p>As a last step we have to increase the ID. Now we can be sure that our request will work out just fine and everything will be cleaned up. But is it too early to party?</p>\n<h3 id=\"even-jsonp-has-downsides\"><a href=\"#even-jsonp-has-downsides\" aria-label=\"even jsonp has downsides permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Even JSONP has downsides</h3>\n<p>JSONP has downsides. Some pretty major downsides, even. First off, there is no proper error handling. As there are no status codes and no response codes sent, you'll have to hope for the best to happen. And there is more than one place where things can go wrong.</p>\n<p>The url you requested can be outdated or simply contain a typo. The <code class=\"language-text\">jsonp</code> function has no way to know about this as it just insterts a script onto the page. But even if the request is successful you'll have to check if the data returned is correct and there is no standardised way to do this. Some APIs offer error messages, some don't. And usually, no two API providers structure their content the same way.</p>\n<p>As with every other technology, security concerns are raised, but with JSONP, the concerns have a valid point. A script requested through JSONP can hold any JavaScript. There is no globally accepted specification that forces a specific format. That means your requested file can happily execute whatever it wants to and you probably won't even notice it. There are <a href=\"http://json-p.org\" title=\"Proposal for safer JSONP\">proposals for a safer solution</a>, but they have yet to be enforced.</p>\n<h3 id=\"conclusion\"><a href=\"#conclusion\" aria-label=\"conclusion permalink\" class=\"anchor\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Conclusion</h3>\n<p>There's not too much of a conclusion to draw here. Use JSONP if you want to use an API that doesn't support CORS. Don't use JSONP if you're too concerned about security issues or want proper error handling.</p>\n<p>Note that, while this function is rather robust and works in most situations, some APIs don't use <code class=\"language-text\">callback</code> for the parameter name. If that's the case, just change the line in the function.</p>","frontmatter":{"date":"30 May 2015","path":"/articles/jsonp","title":"Creating a JSONP Function"}}},"pageContext":{"isCreatedByStatefulCreatePages":false}}}